import { Injectable } from '@nestjs/common';
import {RTCPeerConnection} from 'wrtc';

@Injectable()
export class PeerService {

//  constructor(private socket: Socket){}
  constructor(){}
  private configuration: RTCConfiguration = {
    iceServers: [{ urls: 'stun:stun.1.google.com:19302' }],
  };

  async newPeer(): Promise<RTCPeerConnection>{
    const peer = await new RTCPeerConnection(this.configuration);
    await this.setupPee
r(peer);
    return await peer;
  }

  private async setupPeer(peer: RTCPeerConnection) {
    peer.onicecandidate = (event) => {
      if (event.candidate) {
  //      this.socket.send('candidate', {candidate: event.candidate});
      }
    };
    peer.addEventListener('connectionstatechange', event => {
      if ((event.target as RTCPeerConnection).connectionState === 'connecting'){
        console.log('connecting');
      } else if (peer.connectionState === 'connected') {
        console.log('connected');
        //if(!this.localStream){
	//  this.setupMedia();
	//}
      } else if (peer.connectionState === 'closed') {
        console.log('closed', peer);
      } else if ((event.target as RTCPeerConnection).connectionState === 'failed'){
        console.log('failed');
      } else if (peer.iceConnectionState === 'disconnected'){
        console.log('disconnected');
      }
    });
    peer.addEventListener('track', event => {
     //if(!this.audio){
     //  this.audio = document.createElement('audio');
     //}
     //this.audio.srcObject = event.streams[0];
     //this.audio.play();
    });
    peer.onnegotiationneeded = async (e) => {
     if(peer.connectionState == 'connecting'){
       console.log('connecting');
     } else if((e.target as RTCPeerConnection).connectionState == 'new') {      
       console.log('new client')
     } else if((e.target as RTCPeerConnection).connectionState == 'failed') {
       console.log('failed');
     } else if ((e.target as RTCPeerConnection).connectionState == 'connected') {
       console.log('renegotiateConnected client');
       const offer = await this.newOffer(peer);
//       this.socket.send('offer', {offer: await offer});
     } 
    }
  }

  private async newOffer(peer: RTCPeerConnection) {
    if(peer.signalingState.toString() === 'clsoed') {
       peer = await this.newPeer();
    }
    const offer = await peer.createOffer({
       offerToReceiveAudio: true,
       offerToReceiveVideo: false,
    });
    await peer.setLocalDescription(offer);
  }

}
